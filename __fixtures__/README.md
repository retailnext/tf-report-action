# OpenTofu JSON Lines Test Fixtures

This directory contains test fixtures for OpenTofu JSON Lines output format.

## Documentation Source

All message types and formats are based on the official OpenTofu documentation:

**Primary Source:**
<https://github.com/opentofu/opentofu/blob/main/website/docs/internals/machine-readable-ui.mdx>

**Published Documentation:**
<https://opentofu.org/docs/internals/machine-readable-ui/>

## Fixture Files

- `plan-with-changes.jsonl` - Example plan output with create, update, and
  delete operations
- `plan-with-errors.jsonl` - Example plan output with diagnostic error messages
- `plan-with-replace.jsonl` - Example plan output with replace operation
- `plan-no-changes.jsonl` - Example plan output when no changes are needed
- `apply-success.jsonl` - Example apply output with successful resource creation
- `resource-drift.jsonl` - Example output showing resource drift detection

## Message Types Covered

These fixtures demonstrate the following OpenTofu JSON message types:

- `version` - OpenTofu version and UI schema version
- `planned_change` - Resources that will be created/updated/deleted
- `change_summary` - Summary of all planned or applied changes
- `diagnostic` - Error and warning messages
- `resource_drift` - Resources changed outside of OpenTofu
- `apply_start` - Start of apply operation on a resource
- `apply_progress` - Progress updates during apply
- `apply_complete` - Completion of apply operation

## Updating Fixtures

When updating these fixtures or adding new ones:

1. Refer to the official documentation (link above) for the correct format
1. Ensure all required fields are present (@level, @message, @module,
   @timestamp, type)
1. Use realistic timestamps and resource addresses
1. Test that the parser correctly handles the new fixtures

## exec-action Output Formats

These fixtures also demonstrate both the old and new behavior of
retailnext/exec-action:

### Direct Outputs (Old Behavior)

Files: `steps-with-direct-outputs*.json`

These fixtures use the old exec-action behavior where `stdout` and `stderr` are
provided as direct string values in the step outputs.

### File-Based Outputs (New Behavior)

Files: `steps-with-file-outputs*.json`

These fixtures use the new exec-action behavior where `stdout_file` and
`stderr_file` provide paths to files containing the output. The actual output
files are stored in the `exec-action-outputs/` subdirectory (which is gitignored
and generated by the script).

### Mixed Outputs

File: `steps-with-mixed-outputs.json`

This fixture demonstrates a workflow where different steps use different output
formats (some direct, some file-based). This ensures the action can handle
transitions during the rollout of the new exec-action behavior.

### Generating exec-action Fixtures

To regenerate the exec-action output fixtures, run:

```bash
npx tsx scripts/generate-test-fixtures.ts
```

This will create:

- JSON fixture files with step definitions
- Output files in `exec-action-outputs/` directory (gitignored)
